define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/modal_factory","core/modal_events","core/key_codes","core_course/accessrestrict"],function(a,b,c,d,e,f,g,h,i,j,k){var l={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},m={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display,.dropdown-toggle",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",ADDSECTIONS:"#changenumsections [data-add-sections]"};g.use("moodle-course-coursebase",function(){var a=M.course.format.get_section_selector();a&&(m.SECTIONLI=a)});var n=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))}),b},o=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getName(c.Node(a.get(0)))}),b},p=function(a){a.addClass(l.EDITINPROGRESS);var b=a.find(m.ACTIONAREA).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},q=function(a){a.addClass(l.EDITINPROGRESS);var b=a.find(m.SECTIONACTIONMENU).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},r=function(a){var b=M.util.add_lightbox(g,g.Node(a.get(0)));return b.show(),b},s=function(a,b,c){window.setTimeout(function(){a.removeClass(l.EDITINPROGRESS),b&&b.hide()},c)},t=function(a,b){a&&window.setTimeout(function(){a.hide()},b)},u=function(a,b){if(k.init(),g.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+a)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(g.one("#"+a)),b){var c=g.one("#"+a+" "+m.MENU).one(m.TOGGLE);c&&c.simulate&&c.simulate("click")}},v=function(b,c){var d=a("#"+b),e="[data-action="+c+"]";"groupsseparate"!==c&&"groupsvisible"!==c&&"groupsnone"!==c||(e="[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]"),d.find(e).is(":visible")?d.find(e).focus():d.find(m.MENU).find(m.TOGGLE).focus()},w=function(b){var c=a("a:visible"),d=!1,e=null;return c.each(function(){if(a.contains(b[0],this))d=!0;else if(d)return e=this,!1}),e},x=function(c,e,f){var g,h=f.attr("data-keepopen"),i=f.attr("data-action"),j=p(c),k=b.call([{methodname:"core_course_edit_module",args:{id:e,action:i,sectionreturn:f.attr("data-sectionreturn")?f.attr("data-sectionreturn"):0}}],!0);"duplicate"===i&&(g=r(f.closest(m.SECTIONLI))),a.when.apply(a,k).done(function(b){var d=w(c);c.replaceWith(b),a("<div>"+b+"</div>").find(m.ACTIVITYLI).each(function(b){u(a(this).attr("id"),h),0===b&&(v(a(this).attr("id"),i),d=null)}),d&&d.focus(),s(c,j,400),t(g,400),c.trigger(a.Event("coursemoduleedited",{ajaxreturn:b,action:i}))}).fail(function(b){s(c,j),t(g);var e=a.Event("coursemoduleeditfailed",{exception:b,action:i});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})},y=function(c,d,e){var f=p(c),g=b.call([{methodname:"core_course_get_module",args:{id:d,sectionreturn:e}}],!0);a.when.apply(a,g).done(function(a){s(c,f,400),D(a)}).fail(function(){s(c,f)})},z=function(a,b){var c=a.attr("class").match(/modtype_([^\s]*)/)[1],f=o(a);e.get_string("pluginname",c).done(function(a){var c={type:a,name:f};e.get_strings([{key:"confirm"},{key:null===f?"deletechecktype":"deletechecktypename",param:c},{key:"yes"},{key:"no"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],b)})})},A=function(a,b){e.get_strings([{key:"confirm"},{key:"yes"},{key:"no"}]).done(function(c){d.confirm(c[0],a,c[1],c[2],b)})},B=function(a,b,f,g,h,i,j){var k=[{key:f,component:g}];return h&&k.push({key:h,component:i}),e.get_strings(k).then(function(d){a.find("span.menu-action-text").html(d[0]),a.attr("title",d[0]);var e="";return h&&(e=d[1],a.attr("title",e)),c.renderPix(b,"core",e)}).then(function(b){a.find(".icon").replaceWith(b),a.attr("data-action",j)})["catch"](d.exception)},C=function(b,c,d,e){var f=c.attr("data-action");if("hide"===f||"show"===f){if("hide"===f?(b.addClass("hidden"),B(c,"i/show","showfromothers","format_"+e,null,null,"show")):(b.removeClass("hidden"),B(c,"i/hide","hidefromothers","format_"+e,null,null,"hide")),void 0!==d.modules)for(var g in d.modules)D(d.modules[g]);void 0!==d.section_availability&&b.find(".section_availability").first().replaceWith(d.section_availability)}else if("setmarker"===f){var h=a(m.SECTIONLI+".current"),i=h.find(m.SECTIONACTIONMENU+" a[data-action=removemarker]");h.removeClass("current"),B(i,"i/marker","highlight","core","markthistopic","core","setmarker"),b.addClass("current"),B(c,"i/marked","highlightoff","core","markedthistopic","core","removemarker")}else"removemarker"===f&&(b.removeClass("current"),B(c,"i/marker","highlight","core","markthistopic","core","setmarker"))},D=function(b){a("<div>"+b+"</div>").find(m.ACTIVITYLI).each(function(){var c=a(this).attr("id");a(m.ACTIVITYLI+"#"+c).replaceWith(b),u(c,!1)})},E=function(c,e,f,g){var h=f.attr("data-action"),i=f.attr("data-sectionreturn")?f.attr("data-sectionreturn"):0,j=q(c),k=b.call([{methodname:"core_course_edit_section",args:{id:e,action:h,sectionreturn:i}}],!0),l=r(c);a.when.apply(a,k).done(function(b){var d=a.parseJSON(b);s(c,j),t(l),c.find(m.SECTIONACTIONMENU).find(m.TOGGLE).focus();var e=a.Event("coursesectionedited",{ajaxreturn:d,action:h});c.trigger(e),e.isDefaultPrevented()||C(c,f,d,g)}).fail(function(b){s(c,j),t(l);var e=a.Event("coursesectioneditfailed",{exception:b,action:h});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})};return g.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(b){var c=a(b.element.getDOMNode()),d=n(c);if(d){var e=c.find("."+l.EDITINGMOVE).attr("data-sectionreturn");y(c,d,e)}}})}),{initCoursePage:function(b){a("body").on("click keypress",m.ACTIVITYLI+" "+m.ACTIVITYACTION+"[data-action]",function(b){if("keypress"!==b.type||13===b.keyCode){var c=a(this),d=c.closest(m.ACTIVITYLI),e=c.attr("data-action"),f=n(d);switch(e){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}f&&(b.preventDefault(),"delete"===e?z(d,function(){x(d,f,c)}):x(d,f,c))}}),a("body").on("click keypress",m.SECTIONLI+" "+m.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(m.SECTIONLI),f=d.closest(m.SECTIONACTIONMENU).attr("data-sectionid");c.preventDefault(),d.attr("data-confirm")?A(d.attr("data-confirm"),function(){E(e,f,d,b)}):E(e,f,d,b)}}),e.get_string("numberweeks").done(function(b){var c=a(m.ADDSECTIONS),d=c.attr("data-add-sections"),e=a('<div><label for="add_section_numsections"></label> <input id="add_section_numsections" type="number" min="1" value="1"></div>');e.find("label").html(b),h.create({title:d,type:h.types.SAVE_CANCEL,body:e.html()},c).done(function(b){var e=a(b.getBody()).find("#add_section_numsections"),f=function(){""+parseInt(e.val())===e.val()&&parseInt(e.val())>=1&&(document.location=c.attr("href")+"&numsections="+parseInt(e.val()))};b.setSaveButtonText(d),b.getRoot().on(i.shown,function(){e.focus().select().on("keydown",function(a){a.keyCode===j.enter&&f()})}),b.getRoot().on(i.save,function(a){a.preventDefault(),f()})})})},replaceSectionActionItem:function(a,b,c,d,e,f,g,h){var i=a.find(m.SECTIONACTIONMENU+" "+b);B(i,c,d,e,f,g,h)}}});